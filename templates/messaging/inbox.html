{% extends "base.html" %}

{% comment %} Author: Cole {% endcomment %}
{% comment %} HTMX: This page displays the user's private messages. It uses HTMX
      within session invite messages to allow users to accept or decline
      the invite directly within the chat window, updating the message
      bubble without a page reload. The page also relies heavily on
      WebSockets for real-time chat messages, typing indicators, and
      displaying the online status of buddies in the sidebar and chat header.
      
{% endcomment %}
      

{% block content %}
<div class="messaging-container">
  <aside class="buddy-list-sidebar">
    <h3>Messages</h3>
    <ul class="styled-list">
      {% for thread in my_threads %}
        <li class="user-presence-container {% if selected_thread and selected_thread.pk == thread.pk %}active{% endif %}"
            data-user-pk="{% for p in thread.other_participants %}{{ p.pk }}{% endfor %}">
          <a href="{% url 'conversation' thread_id=thread.pk %}" class="user-name">
            {% if thread.other_participants|length == 1 %}
              {% with buddy=thread.other_participants.0 %}
                {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
              {% endwith %}
            {% else %}
              Group Chat ({{ thread.participants.count }})
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <section
    class="chat-window"
    {% if selected_thread %}
      data-thread-id="{{ selected_thread.pk }}"
      data-user-id="{{ request.user.pk }}"
      data-user-first-name="{{ request.user.first_name }}"
      data-participant-count="{{ selected_thread.participants.count }}"
    {% endif %}>
    
    {# --- Audio elements for WebRTC --- #}
    <audio id="local-audio" autoplay muted playsinline></audio>
    <audio id="remote-audio" autoplay playsinline></audio>
    
    {% if selected_thread %}
      
      <div class="chat-header">
        <div class="chat-header-main">
            <div class="user-presence-container" data-user-pk="{% for p in selected_thread.other_participants %}{{ p.pk }}{% endfor %}">
                <h4 class="user-name">
                {% if selected_thread.other_participants|length == 1 %}
                    {% with buddy=thread.other_participants.0 %}
                    {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
                    {% endwith %}
                {% else %}
                    {% for p in selected_thread.other_participants|slice:":3" %}{{ p.first_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    {% if selected_thread.other_participants|length > 3 %}...{% endif %}
                {% endif %}
                </h4>
            </div>

            {# --- Call/Hangup Button Wrapper --- #}
            {% if selected_thread.other_participants|length == 1 %}
            <div id="call-controls">
                
                {# --- Clean "Call" Icon --- #}
                <button class="btn btn-secondary btn-sm" id="voice-call-button" title="Start voice call">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px;">
                      <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V15a2 2 0 01-2 2h-1a5 5 0 01-5-5v-1a5 5 0 01-5-5V5z" />
                    </svg>
                </button>
                
                {# --- Clean Hang Up Icon --- #}
                <button class="btn btn-danger btn-sm" id="hang-up-button" title="End call" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px;">
                      <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V15a2 2 0 01-2 2h-1a5 5 0 01-5-5v-1a5 5 0 01-5-5V5z" />
                    </svg>
                </button>
            </div>
            {% endif %}
        </div>

        <div class="typing-indicator" id="typing-indicator" style="display: none; font-size: 0.85rem; color: rgba(var(--u-ink-inv-rgb), 0.6); height: 1.2em;">... is typing</div>
      </div>
      
      <div class="message-list" id="message-list">
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            {% if message.sender != request.user and selected_thread.participants.count > 2 %}
              <small class="message-sender-name">{{ message.sender.first_name }}</small>
            {% endif %}

            {% if 'SESSION_INVITE::' in message.content %}
              {% include "messaging/partials/invite_message.html" %}
            {% else %}
              <div id="message-{{ message.id }}">
                {# --- Check for image or text --- #}
                {% if message.image %}
                  <img src="{{ message.image.url }}" class="chat-image" alt="User image" style="max-width: 100%; border-radius: 12px; margin-top: 5px;">
                {% endif %}
                {% if message.content %}
                  <p>{{ message.content }}</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
      <div class="chat-form-container">
        <form id="messaging-image-upload-form"
              hx-post="{% url 'upload_chat_image' thread_id=selected_thread.pk %}"
              hx-encoding="multipart/form-data" 
              hx-swap="none"
              hx-trigger="change from:#chat-image-input">
            {% csrf_token %}
            <input type="file" name="image" id="chat-image-input" class="visually-hidden" accept="image/*">
        </form>

        <form id="chat-form">
            <button type="button" class="btn btn-secondary" id="chat-image-button" onclick="document.getElementById('chat-image-input').click();" title="Send image">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px;"><path fill-rule="evenodd" d="M15.621 4.379a3 3 0 0 0-4.242 0l-7 7a3 3 0 0 0 4.241 4.243L15.75 8.5a.75.75 0 0 1 1.5 0v.043a3.75 3.75 0 1 1-7.5 0V8.5a2.25 2.25 0 1 0 4.5 0V8.5a.75.75 0 0 1 1.5 0v.043a.75.75 0 0 0 1.5 0V8.5a3 3 0 0 0-3-3Z" clip-rule="evenodd" /></svg>
            </button>
            {{ form.content }}
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
      
    {% else %}
      <div class="no-chat-selected">
        <p>Select a conversation to start chatting.</p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock content %}
