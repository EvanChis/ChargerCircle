{% extends "base.html" %}

{% block content %}
<div class="messaging-container">
  <aside class="buddy-list-sidebar">
    <h3>Messages</h3>
    <ul class="styled-list">
      {% for thread in my_threads %}
        <li class="user-presence-container {% if selected_thread and selected_thread.pk == thread.pk %}active{% endif %}" 
            data-user-pk="{% for p in thread.other_participants %}{{ p.pk }}{% endfor %}">
          <a href="{% url 'conversation' thread_id=thread.pk %}" class="user-name">
            {% if thread.other_participants|length == 1 %}
              {% with buddy=thread.other_participants.0 %}
                {{ buddy.first_name }} {{ buddy.last_name.0 }}.
                {% if buddy.pk in online_user_ids %}<span class="online-indicator"></span>{% endif %}
              {% endwith %}
            {% else %}
              Group Chat ({{ thread.participants.count }})
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <section 
    class="chat-window" 
    {% if selected_thread %}
      data-thread-id="{{ selected_thread.pk }}" 
      data-user-id="{{ request.user.pk }}"
      data-participant-count="{{ selected_thread.participants.count }}"
    {% endif %}>
    {% if selected_thread %}
      <div class="chat-header">
        <div class="user-presence-container" data-user-pk="{% for p in selected_thread.other_participants %}{{ p.pk }}{% endfor %}">
            <h4 class="user-name">
              {% if selected_thread.other_participants|length == 1 %}
                {% with buddy=selected_thread.other_participants.0 %}
                  {{ buddy.first_name }} {{ buddy.last_name.0 }}.
                  {% if buddy.pk in online_user_ids %}<span class="online-indicator"></span>{% endif %}
                {% endwith %}
              {% else %}
                {% for p in selected_thread.other_participants|slice:":3" %}{{ p.first_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                {% if selected_thread.other_participants|length > 3 %}...{% endif %}
              {% endif %}
            </h4>
            <div class="typing-indicator" id="typing-indicator" style="display: none; font-size: 0.85rem; color: rgba(var(--u-ink-inv-rgb), 0.6); height: 1.2em;">... is typing</div>
        </div>
      </div>
      <div class="message-list" id="message-list">
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            {% if message.sender != request.user and selected_thread.participants.count > 2 %}
              <small class="message-sender-name">{{ message.sender.first_name }}</small>
            {% endif %}

            {% if 'SESSION_INVITE::' in message.content %}
              {% include "messaging/partials/invite_message.html" %}
            {% else %}
              <div id="message-{{ message.id }}">
                <p>{{ message.content }}</p>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="chat-form-container">
        <form id="chat-form">
          {{ form.content }}
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    {% else %}
      <div class="no-chat-selected">
        <p>Select a conversation to start chatting.</p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock content %}

{% block extra_scripts %}
{% if selected_thread %}
<script>
  const chatWindow = document.querySelector('.chat-window');
  const threadId = JSON.parse(chatWindow.dataset.threadId);
  const currentUserId = JSON.parse(chatWindow.dataset.userId);
  const participantCount = parseInt(chatWindow.dataset.participantCount, 10);

  const messageList = document.getElementById('message-list');
  const chatForm = document.getElementById('chat-form');
  const messageInput = chatForm.querySelector('.message-input');
  const typingIndicator = document.getElementById('typing-indicator');
  let typingTimer;

  function addMessageToUI(content, senderId, senderFirstName) {
    const messageClass = (senderId === currentUserId) ? 'sent' : 'received';
    const showSenderName = (senderId !== currentUserId && participantCount > 2);
    const senderNameHTML = showSenderName ? `<small class="message-sender-name">${senderFirstName}</small>` : '';
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + messageClass;
    messageDiv.innerHTML = `${senderNameHTML}<div id="new-message-temp"><p>${content}</p></div>`;
    messageList.appendChild(messageDiv);
    messageList.scrollTop = messageList.scrollHeight;
  }

  // Scrolls to the bottom on page load
  messageList.scrollTop = messageList.scrollHeight;

  const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + threadId + '/');
  
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'chat_message') {
        typingIndicator.style.display = 'none';
        if (data.sender_id !== currentUserId) {
            addMessageToUI(data.message, data.sender_id, data.sender_first_name);
        }
    } else if (data.type === 'typing' && data.sender_id !== currentUserId) {
        typingIndicator.style.display = 'block';
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            typingIndicator.style.display = 'none';
        }, 2000);
    }
  };

  chatSocket.onclose = function(e) { console.error('Chat socket closed unexpectedly'); };

  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const message = messageInput.value;
    if (message.trim() === '') return;
    
    addMessageToUI(message, currentUserId, "{{ request.user.first_name }}");
    
    chatSocket.send(JSON.stringify({ 
      'type': 'chat_message', 
      'message': message, 
      'sender_id': currentUserId,
      'sender_first_name': "{{ request.user.first_name }}"
    }));
    messageInput.value = '';
  });

  messageInput.addEventListener('keyup', function(e) {
    chatSocket.send(JSON.stringify({ 'type': 'typing', 'sender_id': currentUserId }));
  });
</script>
{% endif %}
{% endblock extra_scripts %}
