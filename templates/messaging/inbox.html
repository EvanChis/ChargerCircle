{% extends "base.html" %}

{% comment %} Author: Cole {% endcomment %}
{% comment %} HTMX: This page displays the user's private messages. It uses HTMX
      within session invite messages to allow users to accept or decline
      the invite directly within the chat window, updating the message
      bubble without a page reload. The page also relies heavily on
      WebSockets for real-time chat messages, typing indicators, and
      displaying the online status of connections in the sidebar and chat header. {% endcomment %}
      

{% block content %}
<div class="messaging-container">
  <aside class="buddy-list-sidebar">
    <h3>Messages</h3>
    <ul class="styled-list">
      {% for thread in my_threads %}
        <li class="user-presence-container {% if selected_thread and selected_thread.pk == thread.pk %}active{% endif %}"
            data-user-pk="{% for p in thread.other_participants %}{{ p.pk }}{% endfor %}">
          <a href="{% url 'conversation' thread_id=thread.pk %}" class="user-name">
            {% if thread.other_participants|length == 1 %}
              {% with buddy=thread.other_participants.0 %}
                {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
              {% endwith %}
            {% else %}
              Group Chat ({{ thread.participants.count }})
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <section
    class="chat-window"
    {% if selected_thread %}
      data-thread-id="{{ selected_thread.pk }}"
      data-user-id="{{ request.user.pk }}"
      data-user-first-name="{{ request.user.first_name }}"
      data-participant-count="{{ selected_thread.participants.count }}"
    {% endif %}>
    {% if selected_thread %}
      <div class="chat-header">
        <div class="user-presence-container" data-user-pk="{% for p in selected_thread.other_participants %}{{ p.pk }}{% endfor %}">
            <h4 class="user-name">
              {% if selected_thread.other_participants|length == 1 %}
                {% with buddy=selected_thread.other_participants.0 %}
                  {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
                {% endwith %}
              {% else %}
                {% for p in selected_thread.other_participants|slice:":3" %}{{ p.first_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                {% if selected_thread.other_participants|length > 3 %}...{% endif %}
              {% endif %}
            </h4>
            <div class="typing-indicator" id="typing-indicator" style="display: none; font-size: 0.85rem; color: rgba(var(--u-ink-inv-rgb), 0.6); height: 1.2em;">... is typing</div>
        </div>
      </div>
      <div class="message-list" id="message-list">
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            {% if message.sender != request.user and selected_thread.participants.count > 2 %}
              <small class="message-sender-name">{{ message.sender.first_name }}</small>
            {% endif %}

            {% if 'SESSION_INVITE::' in message.content %}
              {% include "messaging/partials/invite_message.html" %}
            {% else %}
              <div id="message-{{ message.id }}">
                <p>{{ message.content }}</p>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="chat-form-container">
        <form id="chat-form">
          {{ form.content }}
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    {% else %}
      <div class="no-chat-selected">
        <p>Select a conversation to start chatting.</p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock content %}
