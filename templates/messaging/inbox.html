{% extends "base.html" %}

{% comment %} Author: Cole {% endcomment %}
{% comment %} HTMX: This page displays the user's private messages. It uses HTMX
      within session invite messages to allow users to accept or decline
      the invite directly within the chat window, updating the message
      bubble without a page reload. The page also relies heavily on
      WebSockets for real-time chat messages, typing indicators, and
      displaying the online status of connections in the sidebar and chat header. {% endcomment %}
      

{% block content %}
<div class="messaging-container">
  <aside class="buddy-list-sidebar">
    <h3>Messages</h3>
    <ul class="styled-list">
      {% for thread in my_threads %}
        <li class="user-presence-container {% if selected_thread and selected_thread.pk == thread.pk %}active{% endif %}"
            data-user-pk="{% for p in thread.other_participants %}{{ p.pk }}{% endfor %}">
          <a href="{% url 'conversation' thread_id=thread.pk %}" class="user-name">
            {% if thread.other_participants|length == 1 %}
              {% with buddy=thread.other_participants.0 %}
                {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
              {% endwith %}
            {% else %}
              Group Chat ({{ thread.participants.count }})
            {% endif %}
          </a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <section
    class="chat-window"
    {% if selected_thread %}
      data-thread-id="{{ selected_thread.pk }}"
      data-user-id="{{ request.user.pk }}"
      data-user-first-name="{{ request.user.first_name }}"
      data-participant-count="{{ selected_thread.participants.count }}"
    {% endif %}>
    
    {# --- Audio elements for WebRTC --- #}
    <audio id="local-audio" autoplay muted playsinline></audio>
    <audio id="remote-audio" autoplay playsinline></audio>
    
    {% if selected_thread %}
      
      <div class="chat-header">
        <div class="chat-header-main">
            <div class="user-presence-container" data-user-pk="{% for p in selected_thread.other_participants %}{{ p.pk }}{% endfor %}">
                <h4 class="user-name">
                {% if selected_thread.other_participants|length == 1 %}
                    {% with buddy=thread.other_participants.0 %}
                    {{ buddy.first_name }} {{ buddy.last_name.0 }}.<span class="online-indicator"></span>
                    {% endwith %}
                {% else %}
                    {% for p in selected_thread.other_participants|slice:":3" %}{{ p.first_name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    {% if selected_thread.other_participants|length > 3 %}...{% endif %}
                {% endif %}
                </h4>
            </div>

            {# --- Call/Hangup Button Wrapper --- #}
            {% if selected_thread.other_participants|length == 1 %}
            <div id="call-controls">
                
                {# Call Icon #}
                <button class="btn btn-secondary btn-sm" id="voice-call-button" title="Start voice call">
                    <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#666666"><path d="M798-120q-125 0-247-54.5T329-329Q229-429 174.5-551T120-798q0-18 12-30t30-12h162q14 0 25 9.5t13 22.5l26 140q2 16-1 27t-11 19l-97 98q20 37 47.5 71.5T387-386q31 31 65 57.5t72 48.5l94-94q9-9 23.5-13.5T670-390l138 28q14 4 23 14.5t9 23.5v162q0 18-12 30t-30 12ZM241-600l66-66-17-94h-89q5 41 14 81t26 79Zm358 358q39 17 79.5 27t81.5 13v-88l-94-19-67 67ZM241-600Zm358 358Z"/></svg>
                </button>
                
                {# Hang Up Icon #}
                <button class="btn btn-danger btn-sm" id="hang-up-button" title="End call" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="#666666"><path d="m136-304-92-90q-12-12-12-28t12-28q88-95 203-142.5T480-640q118 0 232.5 47.5T916-450q12 12 12 28t-12 28l-92 90q-11 11-25.5 12t-26.5-8l-116-88q-8-6-12-14t-4-18v-114q-38-12-78-19t-82-7q-42 0-82 7t-78 19v114q0 10-4 18t-12 14l-116 88q-12 9-26.5 8T136-304Zm104-198q-29 15-56 34.5T128-424l40 40 72-56v-62Zm480 2v60l72 56 40-38q-29-26-56-45t-56-33Zm-480-2Zm480 2Z"/></svg>
                </button>
            </div>
            {% endif %}
        </div>

        <div class="typing-indicator" id="typing-indicator" style="display: none; font-size: 0.85rem; color: rgba(var(--u-ink-inv-rgb), 0.6); height: 1.2em;">... is typing</div>
      </div>
      
      <div class="message-list" id="message-list">
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            {% if message.sender != request.user and selected_thread.participants.count > 2 %}
              <small class="message-sender-name">{{ message.sender.first_name }}</small>
            {% endif %}

            {% if 'SESSION_INVITE::' in message.content %}
              {% include "messaging/partials/invite_message.html" %}
            {% else %}
              <div id="message-{{ message.id }}">
                {# --- Check for image or text --- #}
                {% if message.image %}
                  <img src="{{ message.image.url }}" class="chat-image" alt="User image" style="max-width: 100%; border-radius: 12px; margin-top: 5px;">
                {% endif %}
                {% if message.content %}
                  <p>{{ message.content }}</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      
      <div class="chat-form-container">
        <form id="messaging-image-upload-form"
              hx-post="{% url 'upload_chat_image' thread_id=selected_thread.pk %}"
              hx-encoding="multipart/form-data" 
              hx-swap="none"
              hx-trigger="change from:#chat-image-input">
            {% csrf_token %}
            <input type="file" name="image" id="chat-image-input" class="visually-hidden" accept="image/*">
        </form>

        <form id="chat-form">
            <button type="button" class="btn btn-secondary" id="chat-image-button" onclick="document.getElementById('chat-image-input').click();" title="Send image">
                <svg xmlns="http://www.w3.org/2000/svg" height="36px" viewBox="0 -960 960 960" width="36px" fill="#666666"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Zm140-360q25 0 42.5-17.5T400-620q0-25-17.5-42.5T340-680q-25 0-42.5 17.5T280-620q0 25 17.5 42.5T340-560Z"/></svg>
            </button>
            {{ form.content }}
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
      
    {% else %}
      <div class="no-chat-selected">
        <p>Select a conversation to start chatting.</p>
      </div>
    {% endif %}
  </section>
</div>
{% endblock content %}
