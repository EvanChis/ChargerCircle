{% extends "base.html" %}

{% comment %} Author: Evan {% endcomment %}
{% comment %} HTMX: This page does not contain specific HTMX functionality. It displays
      either the logged-in user's own profile or another user's public
      profile information. 
      
{% endcomment %}


{% block content %}
<div class="content-wrapper">

  <div class="profile-header">
    {% if profile_user.profile.main_image_url %}
      <img id="profile-image-trigger" src="{{ profile_user.profile.main_image_url }}" alt="{{ profile_user.first_name }}'s profile picture" class="profile-main-image" style="cursor: pointer;">
    {% else %}
      <div id="profile-image-trigger" class="profile-main-image-placeholder" style="cursor: pointer;">
        <span>{{ profile_user.first_name.0 }}</span>
      </div>
    {% endif %}

    <div class="profile-info">
      <h2>{{ profile_user.first_name }} {{ profile_user.last_name }}</h2>

      {% if profile_user == request.user %}
        <a href="{% url 'edit_profile' %}" class="btn btn-secondary">Edit Profile</a>
        <a href="{% url 'password_reset' %}" class="btn btn-secondary">Change Password</a>
        <a href="{% url 'logout' %}" class="btn btn-secondary btn-danger">Logout</a>
      {% else %}
        <a href="{% url 'conversation' thread_id=thread.pk %}" class="btn btn-primary">Message</a>
      {% endif %}
    </div>
  </div>

  <p class="profile-bio">{{ profile_user.profile.bio|default:"This user hasn't written a bio yet." }}</p>

  {% if profile_user.courses.all %}
    <div class="course-tags">
      {# MODIFIED: Loop and check tag_type to exclude hidden tags #}
      {% for tag in profile_user.courses.all %}
        {% if tag.tag_type == 'course' or tag.tag_type == 'interest' %}
          <span class="course-tag">{{ tag.name }}</span>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% if profile_images %}
    <h3 style="margin-top: 2rem;">Pictures</h3>
    <div class="card">
      <div class="image-gallery">
        {% for img in profile_images %}
          <div class="image-thumbnail-container">
            <img src="{{ img.image.url }}" 
                 alt="Profile image {{ forloop.counter }}" 
                 class="profile-image-thumb {% if img.is_main %}is-main{% endif %} profile-thumbnail-trigger" 
                 data-gallery-index="{{ forloop.counter0 }}"
                 style="cursor: pointer;">
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

</div>

{# Profile Gallery Modal #}
<div class="modal-backdrop" id="profile-gallery-modal" style="display: none;">
  <button class="modal-close-btn" id="profile-gallery-close">&times;</button>
  
  <div class="modal-content">
    <div class="profile-image-gallery" id="profile-gallery-{{ profile_user.pk }}" data-user-pk="{{ profile_user.pk }}">
      
      {% if profile_images %}
        {% for image in profile_images %}
          <img src="{{ image.image.url }}" 
               alt="{{ profile_user.first_name }}'s profile image" 
               class="profile-gallery-image {% if image.is_main %}active{% elif not image.is_main and forloop.first %}active{% endif %}"
               data-gallery-index="{{ forloop.counter0 }}">
        {% endfor %}
      {% else %}
        <div class="profile-image-placeholder">
          <span>{{ profile_user.first_name.0 }}</span>
        </div>
      {% endif %}

      {% if profile_images.count > 1 %}
        <div class="gallery-controls show-btns">
          <button class="gallery-control-btn left" data-gallery-user="{{ profile_user.pk }}" data-gallery-direction="-1">&#10094;</button>
          <button class="gallery-control-btn right" data-gallery-user="{{ profile_user.pk }}" data-gallery-direction="1">&#10095;</button>
        </div>
        <div class="gallery-pagination">
          {% for image in profile_images %}
            <span class="pagination-dot {% if image.is_main %}active{% elif not image.is_main and forloop.first %}active{% endif %}" 
                  data-gallery-user="{{ profile_user.pk }}" 
                  data-gallery-index="{{ forloop.counter0 }}"></span>
          {% endfor %}
        </div>
      {% endif %}
      
    </div>
  </div>

</div>
{% endblock content %}
