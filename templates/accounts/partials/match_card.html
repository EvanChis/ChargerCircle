{% comment %} Author: Evan {% endcomment %}
{% comment %} HTMX: This partial file is the main card used on the "Discover" page. It uses HTMX to handle the "Skip" and "Like" buttons. When a button is clicked,
    HTMX sends a request and replaces this card with the next potential match. {% endcomment %}

<div class="card match-card">
  <div class="profile-image-gallery" id="profile-gallery-{{ match.user.pk }}" data-user-pk="{{ match.user.pk }}">
    {% if match.user.profile.images.all %}
      {% for image in match.user.profile.images.all %}
        <img src="{{ image.image.url }}" 
             alt="{{ match.user.first_name }}'s profile image" 
             class="profile-gallery-image {% if forloop.first %}active{% endif %}"
             data-image-index="{{ forloop.counter0 }}">
      {% endfor %}
    {% else %}
      <div class="profile-image-placeholder">
        <span>{{ match.user.first_name.0 }}</span>
      </div>
    {% endif %}

    {% if match.user.profile.images.count > 1 %}
      <div class="gallery-controls show-btns">
        <button class="gallery-control-btn left" data-gallery-user="{{ match.user.pk }}" data-gallery-direction="-1">&#10094;</button>
        <button class="gallery-control-btn right" data-gallery-user="{{ match.user.pk }}" data-gallery-direction="1">&#10095;</button>
      </div>
      <div class="gallery-pagination">
        {% for image in match.user.profile.images.all %}
          <span class="pagination-dot {% if forloop.first %}active{% endif %}" 
                data-gallery-user="{{ match.user.pk }}" 
                data-gallery-index="{{ forloop.counter0 }}"></span>
        {% endfor %}
      </div>
    {% endif %}
  </div>
  
  <div class="profile-info">
    <h2>{{ match.user.first_name }} {{ match.user.last_name }}, {{ match.user.age }}</h2>
    {% if match.shared_courses %}
      <div class="course-tags">
          {% for course in match.shared_courses %}
              <span class="course-tag">{{ course.name }}</span>
          {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="cta-buttons match-actions">
    <form id="skip-form" hx-post="{% url 'skip_match' pk=match.user.pk %}" hx-target=".match-card-wrapper" hx-swap="innerHTML" hx-trigger="submitSkip from:body">
      {% csrf_token %}
      <button type="button" class="btn btn-secondary btn-danger" data-discover-action="left">Skip</button>
    </form>
    <form id="like-form" hx-post="{% url 'like_user' pk=match.user.pk %}" hx-target=".match-card-wrapper" hx-swap="innerHTML" hx-trigger="submitLike from:body">
      {% csrf_token %}
      <button type="button" class="btn btn-primary" data-discover-action="right">Like</button>
    </form>
  </div>
</div>
