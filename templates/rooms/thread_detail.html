{% comment %} Author: Angie (Original Logic) / Oju (RT Refactor) {% endcomment %}
{% comment %} HTMX: This page uses HTMX to allow users to edit or delete their posts directly on the page without a full reload. It also uses WebSockets to listen for new replies; when another user posts a reply, it appears in the "Replies" list instantly. {% endcomment %}

{% extends "base.html" %}

{% block content %}
<div class="content-wrapper" id="thread-detail-page" data-room-slug="{{ thread.course.slug|escapejs }}">
  <h2>{{ thread.title }}</h2>
  <p class="meta">Started by {{ thread.author.first_name }} in {{ thread.course.name }}</p>

  {% if original_post %}
  <div class="card original-post" id="post-{{ original_post.id }}">
    <div class="post-meta">
      <strong>{{ original_post.author.first_name }} wrote:</strong>
      {% if original_post.author == request.user %}
        <div class="post-actions">
          <button class="btn btn-secondary btn-sm"
            hx-get="{% url 'edit_post' pk=original_post.id %}"
            hx-target="#post-{{ original_post.id }}"
            hx-swap="outerHTML">
            Edit
          </button>
          <button class="btn btn-secondary btn-sm btn-danger"
            hx-post="{% url 'delete_post' pk=original_post.id %}"
            hx-headers='{"X-HX-Redirect": "{% url 'course_detail' slug=thread.course.slug %}"}'
            hx-confirm="Are you sure? Deleting the original post will delete the entire thread.">
            Delete Thread
          </button>
        </div>
      {% endif %}
    </div>
    <div class="post-content">
      {{ original_post.content|linebreaks }}
    </div>
  </div>
  {% endif %}

  <h3>Replies</h3>
  <div id="post-list">
    {% for post in replies %}
      {% include "rooms/partials/post_item.html" %}
    {% empty %}
      <p>No replies yet. Be the first!</p>
    {% endfor %}
  </div>

  <h3>Post a Reply</h3>
  <form method="post" class="card">
    {% csrf_token %}
    <div class="form-group">
      {{ form.content.label_tag }}
      {{ form.content }}
    </div>
    <button type="submit" class="btn btn-primary">Post Reply</button>
  </form>

</div>
{% endblock content %}
